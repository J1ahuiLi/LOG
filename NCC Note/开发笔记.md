# 参数配置

## NCC上传附件提示：附件大小超过限制，不能上传

1. 用系统管理员登录，打开系统参数设置节点，修改参数——单据附件最大值，修改该参数的参数值，取值范围是0-30

2. 不够用的话修改参数值范围（valuelist根据实际情况修改）

```sql
update pub_sysinittemp set valuelist='0-100' where initcode='AttachLmt';
```

## 模板不存在或已被删除

```sql
SELECT * FROM PUB_PAGE_TEMPLET WHERE CODE ='18203008A_ReportZtransSubject'
UPDATE PUB_TEMPLATE_ASSIGNMENT SET PK_PAGE_TEMPLET = '1001ZZ1LCP00002V54UE' WHERE PAGE_CODE = '18203008A_ReportZtransSubject'
SELECT * FROM PUB_TEMPLATE_ASSIGNMENT where PAGE_CODE = '18203008A_ReportZtransSubject' order BY TS ASC
```



# 功能开发

## 添加分页

### 前端

1. 创建state模型下，相关模块区域下添加

```java
handleModal: {
    showPagination: true,// 显示分页器// 页器操作的回调函数handlePageInfoChange: (props, config, pks, total) => {
    	// 加载表格数据  -> 将数据设置到表格上  -> 更新按钮状态this.onHandle(null, 'handleModal');
    	this.setPageStatus(EDITMODE_EDIT, this.updateBtnStatus);
	}
},

onHandle = (param = {}, modalType) => {
    let pageInfo = this.props.editTable.getTablePageInfo(this.state.handleModal.area);// 页面分页信息ajax({
    	url: '',
    	data: { pageInfo, queryTreeFormatVO: { ...queryInfo, pageCode: this.config.pagecode } },
    	success: (res) => {
        	if (res.data != null) {
            	this.props.editTable.setTableData(handleModal.area, res.data.data['cit_daily_credTable']);
        	}
    	}
	})
}
```

### 后端

```java
// json数据转换
public Object doAction(IRequest request, RequstParamWapper paramWapper) throws Throwable {
    RequestDTO param = VOTransform.toVO(paramWapper.requestString, RequestDTO.class);
    QueryTreeFormatVO queryVo = param.getQueryTreeFormatVO();
    ITService service = ServiceLocator.find(ITService.class);
    List<T> result = service.handleModal(queryVo);
    List<String> allpksList = new ArrayList<String>();
    for (T resultItem : result) {
        allpksList.add(resultItem.getDef2());
    }
    if (allpksList == null || allpksList.size() < 1) {
        return null;
    }
    // 获取结果pk
    String[] allpks = (String[]) allpksList.toArray(new String[allpksList.size()]);
    // 传入全部数据
    param.setAllpks(allpks);
    // 获取页面信息PageInfo pageInfo = param.getPageInfo();
    // 根据分页拿到当前分页的pk
    String[] curPagePks = pageInfo == null ? allpks : paramWapper.pageResult(pageInfo, allpks);
    // 查询当前分页数据
    List<T> finalResult = result.stream().filter(m -> Arrays.stream(curPagePks).anyMatch(def2 -> def2 == m.getDef2())).collect(Collectors.toList());
    // 构造返回结果return buildResult(param, false, null, finalResult.toArray());
}

```

### 数据库

```sql
SELECT * FROM pub_area WHERE code = '';
UPDATE pub_area SET pagination = 'true' WHERE code = '';
```



## 档案唯一性校验及数据隔离（集团管控）

### 元数据

1. 实体和组件的扩展标签：BDMODE,URC,DOC
2. 需要进行唯一性校验的字段的扩展标签：URC
3. 业务接口属性映射：pk_org -> 组织，pk_group -> 集团

### 后端

#### ServiceImpl.java

```java
import nc.itf.toaccflow.ztrans_rc_sub4.ztransrcsub4vo.IZtransRcSub4VOService;
import nc.bs.framework.common.NCLocator;

public String[] listPit_inputPkByCond(String condition, String[] orderPath) throws BusinessException {
    // 查询条件拼接集团信息 Added by Jiahui Li
    String pk_group = InvocationInfoProxy.getInstance().getGroupId();
    sql.append(" where ").append(condition).append(" and pk_group = '" + pk_group + "' ");
}

public void initDefaultData(Pit_input vo) {
    // Added by Jiahui Li
    if(vo.getAttributeValue("pk_group") == null){
        vo.setAttributeValue("pk_group",InvocationInfoProxy.getInstance().getGroupId());
    }
}

private void setAuditInfo(Pit_input... vos) throws BusinessException {
    if (ArrayUtils.isNotEmpty(vos)) {
        // 通过集团获取客户端接口 Added by Jiahui Li
        IZtransRcSub4VOService service = NCLocator.getInstance().lookup(IZtransRcSub4VOService.class);
        Map<String, String> pk_groupToMandt = new HashMap<String, String>();// Map<集团主键，客户端>
        UFDateTime now = new UFDateTime();
        for (Pit_input vo : vos) {
            String pk = getVOPrimaryKey(vo);
            if (StringUtils.isEmpty(pk)) {
                // 设置创建人创建时间
                getMainVO(vo).setAttributeValue("creator", InvocationInfoProxy.getInstance().getUserId());
                getMainVO(vo).setAttributeValue("creationtime", now);
                getMainVO(vo).setAttributeValue("", now);
                getMainVO(vo).setAttributeValue("modifier", null);
                getMainVO(vo).setAttributeValue("modifiedtime", null);
            } else {
                // 设置修改人修改时间
                getMainVO(vo).setAttributeValue("modifier", InvocationInfoProxy.getInstance().getUserId());
                getMainVO(vo).setAttributeValue("modifiedtime", now);
                getMainVO(vo).setAttributeValue("", now);
            }

            // 补充集团信息、客户端信息 added by Jiahui Li
            String pk_group = InvocationInfoProxy.getInstance().getGroupId();
            if (vo.getAttributeValue("pk_group") == null) {
                getMainVO(vo).setAttributeValue("pk_group", pk_group);
            }
            getMainVO(vo).setAttributeValue("pk_org", pk_group);
            getMainVO(vo).setAttributeValue("pk_org_v", pk_group);
            // 补充集团后，如果集团还是空的，需要提示
            if (vo.getAttributeValue("pk_group") == null) {
                ExceptionUtils.wrapBusinessException("未获取到集团！");
            }
            // 补充客户端的值
            if (vo.getAttributeValue("mandt") == null) {
                String mandt = pk_groupToMandt.get(pk_group);
                if (mandt == null) {
                    mandt = service.queryGroupCode(pk_group);
                    pk_groupToMandt.put(pk_group, mandt);
                }
                getMainVO(vo).setAttributeValue("mandt", mandt);
            }
            // 补充客户端后，如果客户端还是空的，需要给出提示
            if (vo.getAttributeValue("mandt") == null) {
                ExceptionUtils.wrapBusinessException("未获取到客户端！");
            }
        }
    }
}
```



## 导入导出

### 导入字段修改

1. 导入导出xml文件中相关字段下添加翻译器ID

```xml
<translator>1001ZZ1LCP000005XP1Y</translator>
```

2. 数据库添加相关字段

```sql
SELECT PK_TRANSLATOR FROM EXCEL_TRANSLATOR WHERE MODULE ='taxm' ORDER BY ts DESC ;
```

### 修改导入导出自定义翻译类

```java
public class AggPit_tax_ledger_hTranslator extends AbstractRefTranslator {

    private Logger logger = LoggerFactory.getLogger(AggTaxRateConfigVOTranslator.class);

    @SuppressWarnings("unchecked")
    @Override
    public String translateExToNC(String srcValue, String metaDataID, ITranslateContext translateContext)
        throws PfxxException {
        //TODO
        // if (translateContext.getProperty().getLabel().equals("县支公司")) {
        // 	 String countryBranchSql = "SELECT cccode, pk_costcenter FROM resa_costcenter";
        //   String val = "";
        //   try {
        //     Map<String, String> countryBranchMap = (Map<String, String>) new BaseDAO()
        //       .executeQuery(countryBranchSql, new KeyValueMapProcessor<String, String>());
        //     val = countryBranchMap.get(srcValue);
        //   } catch (Exception e) {
        //     logger.error(e.getMessage());
        //     return null;
        //   }
        //     return val;
        // }
        return null;
    }
}
```

### 导出字段修改

```java
@SuppressWarnings("unchecked")
@Override
protected ExportDataInfo getValue(Object[] vos, List<InputItem> exportItems, BillDefination billdefination) throws BusinessException {
    ExtendedAggregatedValueObject[] aggvos = getConvertorForTemp(new DefRefPropertyProcess()).convertDataFromEditorData(billdefination, vos, exportItems);
    //TODO
    // String strMapSql = "SELECT riskcode, RISKCODE_YW FROM "
    //   + "( SELECT RISKCODE_YW, RISKCODE_NAME, RISKCODE, PK_ZTRANS_RCCONVERT, row_number() over(PARTITION BY RISKCODE_YW,RISKCODE_NAME,RISKCODE ORDER BY RISKCODE_YW) AS rk FROM "
    //   + "( SELECT trim(RISKCODE_YW) RISKCODE_YW, trim(RISKCODE_NAME) RISKCODE_NAME, trim(RISKCODE) RISKCODE, trim(PK_ZTRANS_RCCONVERT) PK_ZTRANS_RCCONVERT FROM ztrans_rcconvert UNION SELECT trim(RISKCODE_YW) RISKCODE_YW, '_', trim(RISKCODE) RISKCODE, PK_ZCIS_RCCONVERT  FROM zcis_rcconvert ) ) WHERE rk =1";
    // Map<String, String> ywCodeMap = (Map<String, String>) new BaseDAO().executeQuery(strMapSql.toString(), new KeyValueMapProcessor<String, String>());
    // try {
    //     for (ExtendedAggregatedValueObject aggvo : aggvos) {
    //         aggvo.getParentVO().setAttributeValue("pk_taxcode", ywCodeMap.get(aggvo.getParentVO().getAttributeValue("pk_taxcode")));
    //     }
    // } catch (Exception e) {
    //     Logger.error(e);
    // }

    return new ExportDataInfo(aggvos);
}
```

### 导入字段赋值

```java
@Override
public AggTaxRateConfigVO[] saveAggTaxRateConfigVO(AggTaxRateConfigVO vo) throws BusinessException {
    //TODO
    // vo.getParentVO().setPk_type1name(type1Name.get(vo.getParentVO().getPk_type1()));
    if (StringUtils.isEmpty(pk)) {
        return dao.insert(vo);// 插入
    } else {
        return dao.update(vo);// 更新
    }
}
```



## 模态框导出EXCEL

### 后端

#### ExportExcelAction.java

```java
public class ExportExcelZiDownBatchVOAction extends AbstractFormDecodeAction {
    @Override
    public Object excute(String param, IRequest request) {
        Map<String, String> tsMap = JSONObject.parseObject(param, Map.class);
        if (tsMap == null || tsMap.size() == 0) {
            throw new BusinessException("通过getTsMap()获取pk与ts组成的Map集合作为参数时未获取到，请传递tsMap");
        }
        List<String> listPk = new ArrayList<String>();
        tsMap.forEach((key, value) -> {
            listPk.add(key);
        });
        if (listPk == null || listPk.size() <= 0) {
            throw new BusinessException("请选择一条数据！");
        }

        // 获取参数String pk = listPk.get(0);
        if (StringUtil.isEmpty(pk)) {
            throw new BusinessException("主批次号不能为空！");
        }
        ICollDownBatchManagerService service = ServiceLocator.find(ICollDownBatchManagerService.class);
        List<ZifiCheckTopVO> list = new ArrayList<ZifiCheckTopVO>();
        try {
            list = service.check(new String[] { pk });
        } catch (nc.vo.pub.BusinessException e1) {
            // TODO Auto-generated catch block
            e1.printStackTrace();
        }

        String filename = "日结单";
        File onetempfile = null;
        WebFile webfile = null;
        try {
            onetempfile = File.createTempFile(filename, ".tmp");
            UFOEFileUtil.setFileAllPerm(onetempfile);
            this.exportExcel(filename, list, onetempfile);
            InputStream is = new FileInputStream(onetempfile);
            webfile = new WebFile(filename + ".xlsx", is);
        } catch (Exception e) {
            ExceptionUtils.wrapException(e);
        } finally {
            if (onetempfile != null) {
                onetempfile.deleteOnExit();
            }
        }
        return webfile;
    }

    public void exportExcel(String title, List<ZifiCheckTopVO> datas, File file) throws Exception {
        if (datas == null) {
            return;
        }
        UFOEFileUtil.setFileAllPerm(file);
        XSSFWorkbook workbook = new XSSFWorkbook();
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        try {
            // 生成一个表格
            XSSFSheet sheet = workbook.createSheet(title);
            // 第一行样式
            XSSFCellStyle headerStyle = workbook.createCellStyle();
            // 设置这些样式
            XSSFColor headerColor = new XSSFColor();
            headerColor.setRGB(intToByteArray(getIntFromColor(221, 221, 221)));

            headerStyle.setFillForegroundColor(headerColor);
            headerStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
            headerStyle.setBorderBottom(BorderStyle.THIN);
            headerStyle.setBorderLeft(BorderStyle.THIN);
            headerStyle.setBorderRight(BorderStyle.THIN);
            headerStyle.setBorderTop(BorderStyle.THIN);
            headerStyle.setAlignment(HorizontalAlignment.CENTER);
            headerStyle.setVerticalAlignment(VerticalAlignment.CENTER);
            // 生成一个字体
            XSSFFont headerFont = workbook.createFont();
            headerFont.setFontHeightInPoints((short) 10);
            headerFont.setBold(true);
            // 把字体应用到当前的样式
            headerStyle.setFont(headerFont);

            // 普通单元格样式
            XSSFCellStyle cellStyle = workbook.createCellStyle();
            cellStyle.setFillForegroundColor(IndexedColors.WHITE.index);
            cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
            cellStyle.setBorderBottom(BorderStyle.THIN);
            cellStyle.setBorderLeft(BorderStyle.THIN);
            cellStyle.setBorderRight(BorderStyle.THIN);
            cellStyle.setBorderTop(BorderStyle.THIN);
            cellStyle.setAlignment(HorizontalAlignment.LEFT);
            cellStyle.setVerticalAlignment(VerticalAlignment.CENTER);
            // 生成另一个字体
            XSSFFont cellFont = workbook.createFont();
            cellFont.setFontHeightInPoints((short) 10);
            // 把字体应用到当前的样式
            cellStyle.setFont(cellFont);

            // 表体黄色合计样式
            XSSFColor firstColor = new XSSFColor();
            firstColor.setRGB(intToByteArray(getIntFromColor(255, 253, 191)));
            XSSFCellStyle firstStyle = workbook.createCellStyle();
            firstStyle.setFillForegroundColor(firstColor);
            firstStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
            firstStyle.setBorderBottom(BorderStyle.THIN);
            firstStyle.setBorderLeft(BorderStyle.THIN);
            firstStyle.setBorderRight(BorderStyle.THIN);
            firstStyle.setBorderTop(BorderStyle.THIN);
            firstStyle.setAlignment(HorizontalAlignment.LEFT);
            firstStyle.setVerticalAlignment(VerticalAlignment.CENTER);
            XSSFFont firstFont = workbook.createFont();
            firstFont.setFontHeightInPoints((short) 10);
            firstFont.setBold(true);
            firstStyle.setFont(firstFont);

            // 遍历集合数据，产生数据行
            XSSFRow row = null;
            // 默认宽度
            int maxLen = 20;
            List<String> keys = Arrays.asList("batch_head", "prcty", "data_src", "rep_des", "take_des", "count",
                                              "currency", "moneynum");// 列属性// 创建表头
            List<String> headNamelist = Arrays.asList("序号", "下载批次", "利润中心", "方式", "汇总项目", "收付方式", "单证张数", "币别", "金额");
            row = sheet.createRow(0);
            for (int i = 0; i < headNamelist.size(); i++) {
                XSSFCell cell = row.createCell(i);
                cell.setCellStyle(headerStyle);
                cell.setCellValue(headNamelist.get(i));
            }
            // 根据数据创建表体
            for (int i = 0; i < datas.size(); i++) {
                ZifiCheckTopVO data = datas.get(i);
                Map<String, String> describe = BeanUtils.describe(data);
                if (data == null) {
                    continue;
                }
                row = sheet.createRow(i + 1);
                Object value = i + 1;
                String valStr = value == null ? "" : value.toString();
                XSSFCell cell0 = row.createCell(0);
                // 不同填充色
                if (data.getData_src().contains("合计")) {
                    cell0.setCellStyle(firstStyle);
                } else {
                    cell0.setCellStyle(cellStyle);
                }
                cell0.setCellValue(valStr);
                for (int j = 0; j < keys.size(); j++) {
                    value = describe.get(keys.get(j));
                    valStr = value == null ? "" : value.toString();
                    XSSFCell cell = row.createCell(j + 1);
                    // 不同填充色
                    if (data.getData_src().contains("合计")) {
                        cell.setCellStyle(firstStyle);
                    } else {
                        cell.setCellStyle(cellStyle);
                    }
                    cell.setCellValue(valStr);
                }
            }
            sheet.setDefaultColumnWidth(maxLen);
            byte[] bytes = null;
            workbook.write(outputStream);
            outputStream.flush();
            bytes = outputStream.toByteArray();
            try (FileOutputStream stream = new FileOutputStream(file)) {
                stream.write(bytes);
                stream.flush();
            }
        } catch (Exception e) {
            throw new Exception(e);
        } finally {
            if (workbook != null) {
                workbook.close();
            }
            if (outputStream != null) {
                outputStream.close();
            }
        }
        return;
    }
   /**
  	* rgb转int
  	*/
    private static int getIntFromColor(int Red, int Green, int Blue) {
        Red = (Red << 16) & 0x00FF0000;
        Green = (Green << 8) & 0x0000FF00;
        Blue = Blue & 0x000000FF;
        return 0xFF000000 | Red | Green | Blue;
    }

   /**
  	* int转byte[]
  	*/
    public static byte[] intToByteArray(int i) {
        byte[] result = new byte[4];
        result[0] = (byte) ((i >> 24) & 0xFF);
        result[1] = (byte) ((i >> 16) & 0xFF);
        result[2] = (byte) ((i >> 8) & 0xFF);
        result[3] = (byte) (i & 0xFF);
        return result;
    }
}
```

### 前端

```js
modalContext = () =>{
    return(
        <div>
        <div className="nc-bill-top-area he-dui">
        {this.props.cardTable.createCardTable('VerifyTable',{
        onAfterEvent:this.onAfterEditFormlist,
        lazyload:false,
        hideSwitch:()=>{return false;},
        showIndex: true,
            showMaxBtn:true,
                height:600,
                    onRowDoubleClick : this.checkRowClick,
                        // Added by Jiahui Li
                        tableHead: () => {
                            return (<NCButton onClick={ this.handleDtExport.bind(this)}>导出</NCButton>)
}
})}
    </div>
</div>
)
}

handleDtExport(){
    // 构建tsMap:{主键: ts}，适配列表操作列优先从record中取值
    let tsMap = {};
    // 获取选中行
    let selectedRows = this.getCheckedDatas() || [];// 选中行
    selectedRows.forEach(row => Object.assign(tsMap, { [row.values['batch_head'].value]: row.values['ts'].value }));
    // tsMap = {selectedRows[0].values[FIELDS.PRIMARYKEY].value : selectedRows[0].values['ts'].value}
    formDownload({
        params: tsMap,
        url: URLS.exportexcelUrl,
        enctype: 2
    });
}
```

## 传输附件：本地文件保存和文件上传



