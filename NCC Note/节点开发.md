# 开发

## 新建模块

- new -> other -> YonBuilder -> 业务组件

## 新建节点

### 开发元数据

1. MDP资源管理器 -> 新建实体组件 -> 设计元数据 -> 发布元数据。
2. 主体（右键） -> 特征 -> 组织信息，审计信息，档案自定义项（有审批则需额外添加富客户端单据信息，审批流信息）。
3. 从其他元数据复制 业务接口（id，pid）和（pk锁）。
4. 添加pk主键，并设置为主键，且长度为20。
5. 添加code（编码），name（名称），enablestate（启用状态：baseapp -> pubenum）字段。
6. 配置业务接口属性映射
   - id：主键
   - pk_org：组织
   - code：作为参照时的编码，没有则为编码（code）
   - name：作为参照时的名称，没有则为名称（name）
   - pk_group：集团
   - enablestate：启用状态
   - pk锁：主键
7. 主子表或多子表中主表对应的实体，访问器要设置为AggVO，其他一般选择NCVO

### 发布元数据。

1. 应用工厂 -> 代码定制 -> 生成代码。

2. 合并后端代码

   - 将src下的private和public与后端工程相关模块代码下的src合并。

   - 将src下的client与后端工程相关项目下的nccloud/src/client合并。

   - 将META-INF（upm文件），resources（导出excel的xml）与后端工程相关模块代码下的META-INF合并。

3. 合并前端代码

4. 将src与前端工程代码中的src文件夹合并。

5. 菜单注册 -> 自定义菜单升级

6. 职责_集团 -> 分配应用

7. 配置前端config.js

8. 将Action文件与xml文件复制到home里

### 相关报错处理

1. pk_md_bizitfmap冲突：

   ```sql
   DELETE FROM MD_BIZITFMAP WHERE intattrid = '60bdf1fb-95e3-43dc-8feb-f874de9293eb' AND classid = 'da871b0f-d620-4932-bdbd-935eb37ad57b'
   ```

   

# 补丁

## 导出补丁

### 前端

1. 在config.json文件的buildEntryPath下添加节点路径和refer路径
2. TERMAINL中执行npm run patch
3. 将前端补丁replacement/hotwebs/nccloud/resources放入后端补丁replacement/hotwebs/nccloud/resources中

### 后端

1. 编译代码。
2. 选中所有与节点相关代码文件（public, META-INF, client, private）导出。
3. Export->NC Cloud/NC Cloud补丁包->填写补丁名称->选择导出文件路径（补丁命名规范：patch_yyyymmdd_ddmmss_开发者姓名_补丁名）
4. 将home/resources/excel/billdefine下相关模块中的xml文件复制到replacement文件夹相同路径下（replacement文件夹等于home文件夹）。
5. 将upm文件复制到replacement/modules/模块名/META-INF下。
6. 将module.xml复制到replacement相关路径下。

## 上传补丁

- NMC
- 账号密码 admin/admin
- 补丁管理 -> 补丁上传 -> 补丁应用（修改补丁包中packmetadata.xml文件中的id，则可再次上传）

## 数据脚本

1. 升级元数据。

2. 修改模块或节点编码，在数据库中执行并生成sql

   ```sql
   --应用菜单项注册
   SELECT * FROM SM_APPMENUITEM WHERE MENUITEMCODE LIKE '%20H9%' AND PK_MENU = '1004Z510000000000FFL' ORDER BY ts DESC;
   SELECT * FROM sm_createcorp WHERE FUNCCODE ='20H4'
   --模块信息
   SELECT * FROM DAP_DAPSYSTEM WHERE Moduleid IN ('20H9');
   --元数据模块实体
   SELECT * FROM md_module WHERE id = 'taxm'
   --应用注册
   SELECT * FROM SM_APPREGISTER WHERE  parent_id IN ('20H9') OR parent_id IN (SELECT PK_APPREGISTER  FROM SM_APPREGISTER WHERE parent_id IN ('20H9'));
   --应用页面
   SELECT * FROM SM_APPPAGE WHERE  PARENTCODE LIKE '20H9%';
   --页面模板
   SELECT * FROM PUB_PAGE_TEMPLET WHERE APPCODE  LIKE '20H9%';
   --区域
   SELECT * FROM pub_area WHERE TEMPLETID IN (SELECT PK_PAGE_TEMPLET FROM PUB_PAGE_TEMPLET WHERE APPCODE  LIKE '20H9%' );
   --查询区字段
   SELECT * FROM PUB_QUERY_PROPERTY WHERE AREAID IN (SELECT PK_AREA FROM pub_area WHERE TEMPLETID IN (SELECT PK_PAGE_TEMPLET FROM PUB_PAGE_TEMPLET WHERE APPCODE  LIKE '20H9%' ));
   --表单字段属性
   SELECT * FROM PUB_FORM_PROPERTY WHERE AREAID IN (SELECT PK_AREA FROM pub_area WHERE TEMPLETID IN (SELECT PK_PAGE_TEMPLET FROM PUB_PAGE_TEMPLET WHERE APPCODE  LIKE '20H9%' ));
   --页面按钮注册实体
   SELECT * FROM SM_APPBUTNREGISTER WHERE PAGECODE LIKE '20H9%' ;
   --导入导出
   SELECT * FROM EXCEL_OUTPUTPROCESS  WHERE  MODULE ='TOACCFLOW' AND BILLTYPE LIKE '%20H9%';
   SELECT * FROM EXCEL_BILLPROCESS  WHERE   MODULE ='TOACCFLOW' AND BILLTYPE LIKE '%20H9%';
   SELECT * FROM EXCEL_TRANSLATOR WHERE MODULE ='toaccflow' AND TRACLASSNAME LIKE '%ztfilp%' ORDER BY ts DESC ;
   --参照信息SELECT * FROM BD_REFINFO  WHERE MODULENAME  = 'toaccflow' AND code like ('%20H9%');
   --输出模板SELECT * FROM  PUB_PRINT_TEMPLATE  WHERE APPCODE IN ( SELECT CODE FROM SM_APPREGISTER WHERE  parent_id IN ('20H9') OR parent_id IN (SELECT PK_APPREGISTER  FROM SM_APPREGISTER WHERE parent_id IN ('20H9')));
   SELECT * FROM   pub_print_datasource WHERE ctemplateid IN (SELECT ctemplateid FROM  PUB_PRINT_TEMPLATE  WHERE APPCODE IN (SELECT CODE FROM SM_APPREGISTER WHERE  parent_id IN ('20H9') OR parent_id IN (SELECT PK_APPREGISTER  FROM SM_APPREGISTER WHERE parent_id IN ('20H9'))));
   SELECT * FROM PUB_PRINT_CELL WHERE ctemplateid IN (SELECT ctemplateid FROM  PUB_PRINT_TEMPLATE  WHERE APPCODE IN (SELECT CODE FROM SM_APPREGISTER WHERE  parent_id IN ('20H9') OR parent_id IN (SELECT PK_APPREGISTER  FROM SM_APPREGISTER WHERE parent_id IN ('20H9'))));
   SELECT * FROM pub_print_variable WHERE ctemplateid IN (SELECT ctemplateid FROM  PUB_PRINT_TEMPLATE  WHERE APPCODE IN (SELECT CODE FROM SM_APPREGISTER WHERE  parent_id IN ('20H2') OR parent_id IN (SELECT PK_APPREGISTER  FROM SM_APPREGISTER WHERE parent_id IN ('20H9'))));
   SELECT * FROM  pub_print_region WHERE ctemplateid IN (SELECT ctemplateid FROM  PUB_PRINT_TEMPLATE  WHERE APPCODE IN (SELECT CODE FROM SM_APPREGISTER WHERE  parent_id IN ('20H9') OR parent_id IN (SELECT PK_APPREGISTER  FROM SM_APPREGISTER WHERE parent_id IN ('20H9'))));
   --编码控制规则SELECT *FROM pub_bcr_nbcr WHERE CODE = 'taxmtaxrateconfig';
   SELECT* FROM pub_bcr_rulebase WHERE NBCRCODE = 'taxmtaxrateconfig';
   SELECT *FROM pub_bcr_elem WHERE PK_BILLCODEBASE IN  (SELECT PK_BILLCODEBASE FROM pub_bcr_rulebase WHERE NBCRCODE ='taxmtaxrateconfig');
   ---流程SELECT* FROM PUB_BUSICLASS WHERE PK_BILLTYPE='taxconfig';
   SELECT *FROM bd_relatedApp where pk_billtypecode = 'taxconfig' and sence = 3 order by appcode desc;
   SELECT* FROM BD_BILLTYPE WHERE  NODECODE like '20H4%';
   SELECT *FROM  pub_alertregistry WHERE PK_ALERTTYPE ='1001ZZ1000000008JZYW';
   SELECT* FROM pub_alerttype WHERE BUSI_PLUGIN LIKE '%PushBzVoucherPostStatusPlugin%';
   ```

   