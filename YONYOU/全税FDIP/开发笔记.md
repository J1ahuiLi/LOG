

默认展开

```js
<SearchPanel
    // className="small"
    className="search-form"
    form={form}
searchOpen={true} //默认收起
reset={this.reset}
head={paramSearch}
onCallback={onCallback}
search={this.search}
>
```



# 数据过滤及查询条件多选

### 修改SearchArea中index.js的查询条件

在多选的查询字段属性中添加 ```multiple={true}```

修改queryconfition中相关字段的查询状态为 ```'IN'```



```java
package com.yonyoufintech.corptax.adj.bill_power.controller;

public class Adj_billController extends BaseController {
    /**
     * 分页动态查询
     *
     * @param pageRequest 分页及排序参数
     * @param searchMap   查询条件
     * @return 分页结果集
     */
    @ApiOperation(value = "分页动态查询", httpMethod = "POST", tags = "READ", response = Adj_bill.class)
    @ApiResponse(response = Page.class, code = 200, message = "接口返回对象参数")
    @RequestMapping(value = "/list", method = RequestMethod.POST)
    @ResponseBody
    @AccperiodFilterate(type = AccperiodFilterateAspect.TAX_PERIOD)
    public Object list(PageRequest pageRequest, @RequestBody Map<String, Object> searchMap) {
        SearchParams searchParams = new SearchParams();
        List<Map> list = (List<Map>) searchMap.get("whereParams");

        // 查询条件可多选
        for (Map map : list) {
            if(("pk_org").equals(map.get("key"))){
                String temp = map.get("value").toString();
                Set<String> set = CollUtil.newHashSet(temp.split(","));
                map.put("value", set);
            }
        }
        // END

        Map mapSearch = new HashMap<String, Object>();
        mapSearch.put("key", "billtype");
        mapSearch.put("value", "power");
        mapSearch.put("condition", "EQ");
        list.add(mapSearch);

        // 通过数据所属机构进行过滤 START
        Map orgFilter = new HashMap<String, Object>();
        Set set = null;
        try {
            set = JurisdictionUtil.getAuthData();
        } catch (BusinessException e) {
            throw new BusinessException("获取数据权限失败！");
        }
        if (set.size() > 0) {
            orgFilter.put("key", "pk_org");
            orgFilter.put("condition", "IN");
            orgFilter.put("value", set);
            list.add(orgFilter);
        }
        // END

        searchMap.put("whereParams", list);

        searchParams.setSearchMap(searchMap);

        if (pageRequest.getPageSize() == 1) {
            Integer allCount = Integer.MAX_VALUE - 1;
            pageRequest = new PageRequest(pageRequest.getPageNumber(), allCount, pageRequest.getSort());
        }

        Page<Map> page = this.statCommonService.selectFieldsByPage(pageRequest, searchParams, "com.yonyoufintech.corptax.adj.bill_power.entity.Adj_bill");
        EnumValueUtils.i18nEnumMapKeyToValue(page.getContent(), Adj_bill.class);
        Map<String, Object> map = new HashMap<String, Object>();
        map.put("data", page);
        return this.buildMapSuccess(map);
    }
}
```







# 报表函数开发

以 queryAgricultureRelatedLoans 为例

1. 在 ```FuncDefineEnum.java``` 中对函数进行声明，```noneFixed``` 为函数自定义参数

```java
package com.yonyoufintech.taxpublish.function.enums;

public enum FuncDefineEnum {
    QUERYAGRICULTURERELATEDLOANS(new FuncDefine(
        "queryAgricultureRelatedLoans", 
        "com.yonyoufintech.taxpublish.function.service.IncomeTaxService", 
        "queryAgricultureRelatedLoans", 
        "涉农贷款利息", 
        "map(pk_taxorg:'纳税主体UUID',nsnd:'纳税年度',nsqj:'纳税期间',sqqsRq:'开始日期',sqjsRq:'结束日期',noneFixed:'利息收入')", 
        "report"
    )),
}
```

2. 在```incomeTaxMapper.xml```里定义函数sql

```xml
<select id="queryAgricultureRelatedLoans" parameterType="map" resultType="java.math.BigDecimal">
    select
    <if test="_databaseId == 'mysql'">
        <choose>
            <when test="param.valueType!=null and param.valueType!='' and param.valueType == 'int_income'.toString() ">
                sum(ifnull(a.int_income,0))
            </when>
        </choose>
    </if>
    <if test="_databaseId == 'oracle'">
        <choose>
            <when test="param.valueType!=null and param.valueType!='' and param.valueType == 'int_income'.toString() ">
                sum(nvl(a.int_income,0))
            </when>
        </choose>
    </if>
    from et_agricultureRelatedLoans a
    where
    a.dr=0
    <if test="param.year!=null and param.year!='' ">
        and a.create_time like CONCAT(#{param.year},'%')
    </if>
    <!-- <if test="param.sqqs_rq!=null and param.sqqs_rq!='' "> -->
    <!--     and a.startdate = -->
    <!--     #{param.sqqs_rq} -->
    <!-- </if> -->
    <!-- <if test="param.sqjs_rq!=null and param.sqjs_rq!='' "> -->
    <!--     and a.enddate <![CDATA[ <= ]]> -->
    <!--     #{param.sqjs_rq} -->
    <!-- </if> -->
    <if test="param.pkOrgList != null and param.pkOrgList.size() > 0">
        and a.org in
        <!-- 处理in的集合超过1000条时Oracle不支持的情况 -->
        <trim suffixOverrides=" OR a.org IN()">    <!-- 表示删除最后一个条件 -->
            <foreach collection="param.pkOrgList" item="item" index="index" open="(" close=")">
                <if test="index != 0">
                    <choose>
                        <when test="index % 1000 == 999">) OR a.org IN (</when>
                        <otherwise>,</otherwise>
                    </choose>
                </if>
                #{item}
            </foreach>
        </trim>
    </if>
</select>
```



3. 定义函数方法，param中存放函数的参数

```java
package com.yonyoufintech.taxpublish.function.service;

@Service("com.yonyoufintech.taxpublish.function.service.IncomeTaxService")
public class IncomeTaxService {

/**
 * 涉农贷款利息
 *
 * @param param
 * @return
 */
    public BigDecimal queryAgricultureRelatedLoans(Map<String, Object> param) {
        String noneFixed = (null == param.get("noneFixed") ? "" : (String) param.get("noneFixed"));
        String[] paramArray = noneFixed.split(",", -1);
        //取值类型  int_income  利息收入
        param.put("valueType", paramArray[0].toLowerCase());
        param.put("year", param.get("sqjs_rq").toString().substring(0, 4));
        BigDecimal data = incomeTaxMapper.queryAgricultureRelatedLoans(param);
        return data == null ? BigDecimal.ZERO : data;
    }
}
```



4. 声明接口

```java
package com.yonyoufintech.taxpublish.function.dao;

@MyBatisRepository
@Component("com.yonyoufintech.taxpublish.function.dao.IncomeTaxMapper")
public interface IncomeTaxMapper {
/**
 * queryAgricultureRelatedLoans
 * @param param
 * @return
 */
    BigDecimal queryAgricultureRelatedLoans(@Param("param") Map<String, Object> param);
}
```



5. 数据库脚本

```sql
-- 报表函数
SELECT * FROM VT_FUNC_DEFINE WHERE method_name = 'queryAgricultureRelatedLoans '
INSERT INTO VT_FUNC_DEFINE ("ID", "FUNC_NAME", "CLASS_NAME", "METHOD_NAME", "FUNC_TYPE", "FUNC_DESCR", "FUNC_CODE", "DR", "TS", "CUSTOM_FUNC", "TABLE_NAME") VALUES ('7d4c53c1111e4a09860244da8be1ca21', '涉农贷款利息', 'com.yonyoufintech.taxpublish.function.service.CommService', 'queryLoanLossProvision', '01', '涉农贷款利息', 'queryAgricultureRelatedLoans ', '0', '2025-09-18 17:05:22 891', NULL, '涉农贷款利息');

-- 报表函数参数
SELECT  * FROM VT_FUNC_PARAM WHERE function_id = '40437dce8fb245208d27f5656d89dc43'
INSERT INTO VT_FUNC_PARAM ("ID", "FUNCTION_ID", "ROWNO", "PARAM_NAME", "PARAM_TYPE", "PARAM_DESCR", "REF_CODE", "REF_URL", "REF_TYPE", "REQUIRED", "DR", "TS", "CLIENT_PARAMS") VALUES ('4ca73b66476c400c89b48a46182353r4', '7d4c53c1111e4a09860244da8be1ca21', '0', '年度', 'text', '年度', NULL, NULL, NULL, '1', '0', '2025-09-18 17:05:22 891', NULL);
INSERT INTO VT_FUNC_PARAM ("ID", "FUNCTION_ID", "ROWNO", "PARAM_NAME", "PARAM_TYPE", "PARAM_DESCR", "REF_CODE", "REF_URL", "REF_TYPE", "REQUIRED", "DR", "TS", "CLIENT_PARAMS") VALUES ('77b649cee3ab47e892f6063f0a7173r5', '7d4c53c1111e4a09860244da8be1ca21', '1', '行次', 'text', NULL, NULL, NULL, NULL, '1', '0', '2025-09-18 17:05:22 891', NULL);
INSERT INTO VT_FUNC_PARAM ("ID", "FUNCTION_ID", "ROWNO", "PARAM_NAME", "PARAM_TYPE", "PARAM_DESCR", "REF_CODE", "REF_URL", "REF_TYPE", "REQUIRED", "DR", "TS", "CLIENT_PARAMS") VALUES ('ece87570d3fd42f89241a99b788d63r6', '7d4c53c1111e4a09860244da8be1ca21', '2', '类型', 'enum', '类型', NULL, NULL, NULL, '0', '0', '2025-09-18 17:05:22 891', NULL);
INSERT INTO VT_FUNC_PARAM ("ID", "FUNCTION_ID", "ROWNO", "PARAM_NAME", "PARAM_TYPE", "PARAM_DESCR", "REF_CODE", "REF_URL", "REF_TYPE", "REQUIRED", "DR", "TS", "CLIENT_PARAMS") VALUES ('ece87570d3fd42f89241a99b788d63r7', '7d4c53c1111e4a09860244da8be1ca21', '3', '取值类型', 'enum', '取值类型', NULL, NULL, NULL, '1', '0', '2025-09-18 17:05:22 891', NULL);

-- 报表函数参数枚举
SELECT * FROM VT_FUNC_ENUMVAL WHERE param_id = '4e511cdf094c42c08ed88adccc704fde'
INSERT INTO VT_FUNC_ENUMVAL ("ID", "PARAM_ID", "ROWNO", "CODE", "VAL", "DR", "TS") VALUES ('430e48b877764f29ac37901ff863b81m', 'ece87570d3fd42f89241a99b788d63r6', '0', '0', '正常类', '0', '2025-09-18 17:05:22 891');
INSERT INTO VT_FUNC_ENUMVAL ("ID", "PARAM_ID", "ROWNO", "CODE", "VAL", "DR", "TS") VALUES ('430e48b877764f29ac37901ff863b82m', 'ece87570d3fd42f89241a99b788d63r6', '1', '1', '关注类', '0', '2025-09-18 17:05:22 891');
INSERT INTO VT_FUNC_ENUMVAL ("ID", "PARAM_ID", "ROWNO", "CODE", "VAL", "DR", "TS") VALUES ('430e48b877764f29ac37901ff863b83m', 'ece87570d3fd42f89241a99b788d63r6', '2', '2', '次级类', '0', '2025-09-18 17:05:22 891');
INSERT INTO VT_FUNC_ENUMVAL ("ID", "PARAM_ID", "ROWNO", "CODE", "VAL", "DR", "TS") VALUES ('430e48b877764f29ac37901ff863b84m', 'ece87570d3fd42f89241a99b788d63r6', '3', '3', '可疑类', '0', '2025-09-18 17:05:22 891');
INSERT INTO VT_FUNC_ENUMVAL ("ID", "PARAM_ID", "ROWNO", "CODE", "VAL", "DR", "TS") VALUES ('430e48b877764f29ac37901ff863b85m', 'ece87570d3fd42f89241a99b788d63r6', '4', '4', '损失类', '0', '2025-09-18 17:05:22 891');
INSERT INTO VT_FUNC_ENUMVAL ("ID", "PARAM_ID", "ROWNO", "CODE", "VAL", "DR", "TS") VALUES ('430e48b877764f29ac37901ff863b86m', 'ece87570d3fd42f89241a99b788d63r7', '0', 'loans_balance', '年末合计贷款余额', '0', '2025-09-18 17:05:22 891');
```

