## NCC档案唯一性校验及数据隔离（集团管控）

## 元数据

1. 实体和组件的扩展标签：BDMODE,URC,DOC
2. 需要进行唯一性校验的字段的扩展标签：URC
3. 业务接口属性映射：pk_org -> 组织，pk_group -> 集团

## 后端

`ServiceImpl.java`

```java
import nc.itf.toaccflow.ztrans_rc_sub4.ztransrcsub4vo.IZtransRcSub4VOService;
import nc.bs.framework.common.NCLocator;

public String[] listPit_inputPkByCond(String condition, String[] orderPath) throws BusinessException {
    // 查询条件拼接集团信息 Added by Jiahui Li
    String pk_group = InvocationInfoProxy.getInstance().getGroupId();
    sql.append(" where ").append(condition).append(" and pk_group = '" + pk_group + "' ");
}

public void initDefaultData(Pit_input vo) {
    // Added by Jiahui Li
    if(vo.getAttributeValue("pk_group") == null){
        vo.setAttributeValue("pk_group",InvocationInfoProxy.getInstance().getGroupId());
    }
}

private void setAuditInfo(Pit_input... vos) throws BusinessException {
    if (ArrayUtils.isNotEmpty(vos)) {
        // 通过集团获取客户端接口 Added by Jiahui Li
        IZtransRcSub4VOService service = NCLocator.getInstance().lookup(IZtransRcSub4VOService.class);
        Map<String, String> pk_groupToMandt = new HashMap<String, String>();// Map<集团主键，客户端>
        UFDateTime now = new UFDateTime();
        for (Pit_input vo : vos) {
            String pk = getVOPrimaryKey(vo);
            if (StringUtils.isEmpty(pk)) {
                // 设置创建人创建时间
                getMainVO(vo).setAttributeValue("creator", InvocationInfoProxy.getInstance().getUserId());
                getMainVO(vo).setAttributeValue("creationtime", now);
                getMainVO(vo).setAttributeValue("", now);
                getMainVO(vo).setAttributeValue("modifier", null);
                getMainVO(vo).setAttributeValue("modifiedtime", null);
            } else {
                // 设置修改人修改时间
                getMainVO(vo).setAttributeValue("modifier", InvocationInfoProxy.getInstance().getUserId());
                getMainVO(vo).setAttributeValue("modifiedtime", now);
                getMainVO(vo).setAttributeValue("", now);
            }

            // 补充集团信息、客户端信息 added by Jiahui Li
            String pk_group = InvocationInfoProxy.getInstance().getGroupId();
            if (vo.getAttributeValue("pk_group") == null) {
                getMainVO(vo).setAttributeValue("pk_group", pk_group);
            }
            getMainVO(vo).setAttributeValue("pk_org", pk_group);
            getMainVO(vo).setAttributeValue("pk_org_v", pk_group);
            // 补充集团后，如果集团还是空的，需要提示
            if (vo.getAttributeValue("pk_group") == null) {
                ExceptionUtils.wrapBusinessException("未获取到集团！");
            }
            // 补充客户端的值
            if (vo.getAttributeValue("mandt") == null) {
                String mandt = pk_groupToMandt.get(pk_group);
                if (mandt == null) {
                    mandt = service.queryGroupCode(pk_group);
                    pk_groupToMandt.put(pk_group, mandt);
                }
                getMainVO(vo).setAttributeValue("mandt", mandt);
            }
            // 补充客户端后，如果客户端还是空的，需要给出提示
            if (vo.getAttributeValue("mandt") == null) {
                ExceptionUtils.wrapBusinessException("未获取到客户端！");
            }
        }
    }
}
```

